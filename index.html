<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üíù Happy Valentine's Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-100 min-h-screen flex items-center justify-center">
    <!-- ‡∏´‡∏ô‡πâ‡∏≤ Welcome ‡∏ö‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏à‡∏≠ -->
  <div id="welcomeScreen"
    class="fixed inset-0 bg-pink-200 flex items-center justify-center z-50">

    <button onclick="enterCard()"
      class="bg-white text-pink-500 px-8 py-4 rounded-2xl shadow-xl text-xl animate-pulse">
      üéÅ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© üíù
    </button>
  </div>

  <!-- ‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <audio id="bgMusic" loop>
    <source id="musicSource" type="audio/mpeg">
  </audio>

  <div class="bg-white shadow-2xl rounded-3xl p-8 w-full max-w-md text-center relative overflow-hidden">
    <div class="absolute inset-0 pointer-events-none">
      <div class="animate-pulse text-pink-300 text-7xl absolute top-4 left-4">‚ù§</div>
      <div class="animate-pulse text-pink-200 text-5xl absolute bottom-6 right-6">‚ù§</div>
    </div>

    <h1 class="text-2xl font-bold text-pink-500 mb-4">üíù Happy Valentine's Day</h1>

    <div class="bg-pink-50 rounded-2xl p-6 shadow-inner min-h-[140px] flex flex-col items-center justify-center space-y-2">
      <p class="text-sm text-pink-400">
        to <span id="toText"></span>
      </p>
      <p id="cardText" class="text-lg text-pink-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...</p>
    </div>

    <div class="mt-6 space-y-3">
      <button id="musicBtn"
        onclick="toggleMusic()"
        class="w-full bg-gray-300 hover:bg-gray-400 text-white py-2 rounded-full shadow transition">
        ‚è∏Ô∏è ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á
      </button>

      <p class="text-sm text-gray-400">
        from <span id="customerName"></span>
      </p>
    </div>

    <p id="error" class="text-xs text-gray-200 mt-4"></p>
  </div>

  <!-- Version (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 3 ‡∏ß‡∏¥‡πÉ‡∏´‡πâ‡πÇ‡∏ú‡∏•‡πà) -->
  <div id="versionTag"
    class="fixed bottom-2 right-3 text-[10px] text-gray-300 opacity-0 transition select-none">
  </div>

  <!-- SCRIPT ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î -->
  <script>
  /************************
   * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
   ************************/
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFqWscb3Yr7tpblr-pnre134YC-V2eRPwuhWK2FiVN1q164QiBtxlPA0zGZw8d7sBHrJaUWKppkTqZ/pub?output=csv";
  const DEFAULT_MUSICCC = "https://www.bensound.com/bensound-music/bensound-november.mp3";
  const DEFAULT_MUSIC = "https://res.cloudinary.com/do1jsdim9/video/upload/v1769009220/love-story-156946_ygw34n.mp3";

  // ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏≠‡∏õ
  const APP_VERSION = "v1.0.0";

  /************************
   * DOM
   ************************/
  const music = document.getElementById("bgMusic");
  const musicSource = document.getElementById("musicSource");
  const nameEl = document.getElementById("customerName");
  const msgEl = document.getElementById("cardText");
  const toEl = document.getElementById("toText");
  const errorEl = document.getElementById("error");
  const musicBtn = document.getElementById("musicBtn");
  const versionTag = document.getElementById("versionTag");

  /************************
   * URL ID
   ************************/
  const params = new URLSearchParams(window.location.search);
  const requestId = (params.get("id") || "").trim().toLowerCase();

  /************************
   * ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á
   ************************/
function enterCard() {
  // ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏•‡∏á
  if (!musicSource.src) {
    musicSource.src = DEFAULT_MUSIC;
    music.load();
  }

  music.play();

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô
  musicBtn.classList.remove("bg-gray-300", "hover:bg-gray-400");
  musicBtn.classList.add("bg-rose-300", "hover:bg-rose-400");
  musicBtn.textContent = "üéµ ‡πÄ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á";

  // ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Welcome
  document.getElementById("welcomeScreen").style.display = "none";
}
    
  function toggleMusic() {
    if (!musicSource.src) {
      musicSource.src = DEFAULT_MUSIC;
      music.load();
    }

    if (music.paused) {
      music.play();

      // ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô = ‡∏ä‡∏°‡∏û‡∏π
      musicBtn.classList.remove("bg-gray-300", "hover:bg-gray-400");
      musicBtn.classList.add("bg-rose-300", "hover:bg-rose-400");
      musicBtn.textContent = "üéµ ‡πÄ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á";
    } else {
      music.pause();

      // ‡πÇ‡∏´‡∏°‡∏î‡∏´‡∏¢‡∏∏‡∏î = ‡πÄ‡∏ó‡∏≤
      musicBtn.classList.remove("bg-rose-300", "hover:bg-rose-400");
      musicBtn.classList.add("bg-gray-300", "hover:bg-gray-400");
      musicBtn.textContent = "‚è∏Ô∏è ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á";
    }
  }

  if (!requestId) {
    errorEl.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö RequestId ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå";
  } else {
    loadData();
  }

  /************************
   * CSV Parser
   ************************/
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      const next = text[i + 1];

      if (char === '"' && inQuotes && next === '"') {
        field += '"';
        i++;
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        row.push(field.trim());
        field = "";
      } else if ((char === "\n" || char === "\r") && !inQuotes) {
        if (field || row.length) {
          row.push(field.trim());
          rows.push(row);
        }
        row = [];
        field = "";
      } else {
        field += char;
      }
    }

    if (field || row.length) {
      row.push(field.trim());
      rows.push(row);
    }

    return rows;
  }

  /************************
   * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
   ************************/
  async function loadData() {
    try {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();

      const data = parseCSV(text);
      const rows = data.slice(1);

      let found = false;

      for (let cols of rows) {
        const customerName = cols[0];
        const message = cols[1];
        const musicLink = cols[2];
        const toText = cols[3];
        const id = (cols[4] || "").replace(/\s/g, "").toLowerCase();

        if (id === requestId) {
          nameEl.textContent = customerName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©";
          msgEl.innerHTML = (message || "‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå üíï").replace(/\\n/g, "<br>");
          toEl.textContent = toText || "‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì";

          const song = musicLink && musicLink.length > 5
            ? musicLink
            : DEFAULT_MUSIC;

          musicSource.src = song;
          music.load();
          found = true;
          break;
        }
      }

      if (!found) {
        errorEl.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ";
      }

    } catch (err) {
      errorEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üíî";
      console.error(err);
    }
  }

  /************************
   * Version (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 3 ‡∏ß‡∏¥)
   ************************/
  versionTag.textContent = APP_VERSION;

  let pressTimer = null;

  function startPress() {
    pressTimer = setTimeout(() => {
      versionTag.classList.remove("opacity-0");
      versionTag.classList.add("opacity-70");
    }, 3000); // 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  }

  function cancelPress() {
    clearTimeout(pressTimer);
  }

  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ + ‡∏Ñ‡∏≠‡∏°
  document.addEventListener("mousedown", startPress);
  document.addEventListener("mouseup", cancelPress);
  document.addEventListener("touchstart", startPress);
  document.addEventListener("touchend", cancelPress);
  </script>
</body>
</html>
