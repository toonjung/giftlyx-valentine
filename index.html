<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>üíù Happy Valentine's Day</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-100 min-h-screen flex items-center justify-center">

  <!-- ‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <audio id="bgMusic" loop></audio>

  <div class="bg-white shadow-2xl rounded-3xl p-8 w-full max-w-md text-center relative overflow-hidden">
    <div class="absolute inset-0 pointer-events-none">
      <div class="animate-pulse text-pink-300 text-7xl absolute top-4 left-4">‚ù§</div>
      <div class="animate-pulse text-pink-200 text-5xl absolute bottom-6 right-6">‚ù§</div>
    </div>

    <h1 class="text-2xl font-bold text-pink-500 mb-4">üíù Happy Valentine's Day</h1>

    <div class="bg-pink-50 rounded-2xl p-6 shadow-inner min-h-[140px] flex flex-col items-center justify-center space-y-2">
      <p class="text-sm text-pink-400">
        to <span id="toText"></span>
      </p>
      <p id="cardText" class="text-lg text-pink-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤...</p>
    </div>

    <div class="mt-6 space-y-3">
      <button
        onclick="toggleMusic()"
        class="w-full bg-rose-300 hover:bg-rose-400 text-white py-2 rounded-full shadow transition"
      >
        üéµ ‡πÄ‡∏õ‡∏¥‡∏î / ‡∏õ‡∏¥‡∏î ‡πÄ‡∏û‡∏•‡∏á
      </button>
     <p class="text-sm text-gray-400">
       from <span id="customerName"></span>
      </p>
    </div>

    <p id="error" class="text-xs text-red-400 mt-4"></p>
  </div>

  <!-- SCRIPT ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î -->
  <script>
  /************************
   * ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
   ************************/
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSFqWscb3Yr7tpblr-pnre134YC-V2eRPwuhWK2FiVN1q164QiBtxlPA0zGZw8d7sBHrJaUWKppkTqZ/pub?output=csv";
  const DEFAULT_MUSIC = "https://www.bensound.com/bensound-music/bensound-november.mp3";

  /************************
   * DOM
   ************************/
  const music = document.getElementById("bgMusic");
  const nameEl = document.getElementById("customerName");
  const msgEl = document.getElementById("cardText");
  const toEl = document.getElementById("toText");
  const errorEl = document.getElementById("error");

  /************************
   * URL ID
   ************************/
  const params = new URLSearchParams(window.location.search);
  const requestId = (params.get("id") || "").trim().toLowerCase();

  function toggleMusic() {
    if (!music.src) {
      music.src = DEFAULT_MUSIC;
    }
    if (music.paused) {
      music.play();
    } else {
      music.pause();
    }
  }

  if (!requestId) {
    errorEl.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö RequestId ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå";
  } else {
    loadData();
  }

  /************************
   * CSV Parser
   ************************/
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let field = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      const next = text[i + 1];

      if (char === '"' && inQuotes && next === '"') {
        field += '"';
        i++;
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        row.push(field.trim());
        field = "";
      } else if ((char === "\n" || char === "\r") && !inQuotes) {
        if (field || row.length) {
          row.push(field.trim());
          rows.push(row);
        }
        row = [];
        field = "";
      } else {
        field += char;
      }
    }

    if (field || row.length) {
      row.push(field.trim());
      rows.push(row);
    }

    return rows;
  }

  /************************
   * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
   ************************/
  async function loadData() {
    try {
      const res = await fetch(SHEET_CSV_URL);
      const text = await res.text();

      const data = parseCSV(text);
      const rows = data.slice(1);

      let found = false;

      for (let cols of rows) {
        const customerName = cols[0];
        const message = cols[1];
        const musicLink = cols[2];
        const toText = cols[3];
        const id = (cols[4] || "").replace(/\s/g, "").toLowerCase();


        if (id === requestId) {
          nameEl.textContent = customerName || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©";
          msgEl.innerHTML = (message || "‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå üíï").replace(/\\n/g, "<br>");
          toEl.textContent = toText || "‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏∏‡∏ì";

          const song = musicLink && musicLink.length > 5
            ? musicLink
            : DEFAULT_MUSIC;

          music.src = song;
          found = true;
          break;
        }
      }

      if (!found) {
        errorEl.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ";
      }

    } catch (err) {
      errorEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üíî";
      console.error(err);
    }
  }
  </script>
</body>
</html>
